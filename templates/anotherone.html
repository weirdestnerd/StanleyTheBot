{% extends "analyze.html" %}

{% block chat_interface %}
{{super()}}
<div class="row">
  <div class="col s12 m6 l6 offset-m6 offset-l6">
    <div class="row">
      <div class="col s12 m6 l6 offset-m6 offset-l6">
        <div class="card-panel red lighten-2">
          <span id="user_say" class="white-text">Try another photo
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col s12 m5">
    <div class="card-panel red lighten-2">
      <span id="bot_say" class="white-text">Go ahead! Pick another photo
      </span>
    </div>
  </div>
</div>

{% block anotherone %}
<div class="row">
  <div class="col s12 m6 l6 offset-m6 offset-l6">
    <form action="analyze" method="post" enctype=multipart/form-data>
      <div class="file-field input-field">
          <input type="file" name="img_to_process" id="img_to_process" accept="image/*">
        <div class="file-path-wrapper">
          <input class="file-path validate" type="text" placeholder="Pick a photo">
        </div>
        <div id="loader" class="progress hide">
          <div class="indeterminate"></div>
      </div>
        <input class="hide" id="hiddenUrl" name="hiddenUrl" type="text">
      </div>
      <button class="btn waves-effect waves-light disabled" id="analyize" type="submit" name="action"><i class="material-icons right">send</i>
      </button>
    </form>
  </div>
</div>

<script>
    //get element
    var imageSubmit = document.getElementById('img_to_process')
    //when image is chosen
    imageSubmit.addEventListener('change', e => {
      //get the image chosen
      image = e.target.files[0]
      
      if (image.size > 2000000) {
        console.log(image.size);
        $('document').ready(Materialize.toast('Your image is large and might take a while to upload', 5000));
      }
      //reference to firebase storage
      var imageRef = firebase.storage().ref('images/' + image.name)
      //upload chosen image to firebase storage
      uploadTask = imageRef.put(image)
      //while the image is uploading
      uploadTask.on('state_changed', snapshot => {
        //show loading animation
        document.getElementById('loader').classList.remove('hide')
        //get upload status
        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        //when upload is done
        if (progress == 100) {
          //remove the loading animation
          document.getElementById('loader').classList.add('hide')
        }
      }, error => {//if there's an error
    },//what to do when upload is done
        function() {
          console.log("done uploading");
          //add the URL to the image to the hidden input
          document.getElementById('hiddenUrl').value = uploadTask.snapshot.downloadURL
          //make button clickable
          document.getElementById('analyize').classList.remove('disabled')
        })
    })
    //show processing
    document.getElementById('analyize').addEventListener('click', function() {
      document.getElementById('processing').classList.remove('hide')
    });
</script>
{% endblock %}

{% endblock %}{% block user_response %}{% endblock %}
